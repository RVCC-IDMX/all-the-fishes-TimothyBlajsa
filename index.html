<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All The Fishes</title>
    <link rel="shortcut icon" href="img/favicon.png" type="image/x-icon">
    <script src="https://pixijs.download/release/pixi.js">
    </script>
</head>

<body style="background-color: rgb(67, 81, 95);">
    <h1></h1>
    <script>

        // Audio event listener
        let audio = document.createElement("audio");
        audio.autoplay = true;
        audio.src = "aquarium.wav";

        document.addEventListener("mousemove", () => {
            audio.play();
        });

        // The App
        var app = new PIXI.Application({
            width: 640,
            height: 400,
            //background: 'img/background.jpg'
            backgroundColor: 0x000000
        });

        // Add view to the document
        document.body.appendChild(app.view);

        // My First Sprite
        let fish1 = PIXI.Sprite.from("img/bigfish.png");

        // Change sprite coordinates
        fish1.x = 420;
        fish1.y = 0;

        // Change sprite size
        fish1.scale.set(.095);

        // Add it to the stage
        app.stage.addChild(fish1);

        // My Second Sprite
        let fish2 = PIXI.Sprite.from("img/smallfish.png");

        // Change sprite2 size
        fish2.scale.set(.07);
        fish2.x = 30;

        // Add it to the stage
        app.stage.addChild(fish2);

        // My background sprite
        let background = PIXI.Sprite.from("img/background.jpg");
        background.scale.set(.7);
        app.stage.addChild(background);

        // My kelp sprite
        let kelp1 = PIXI.Sprite.from("img/kelp.png");
        kelp1.scale.set(.5);
        kelp1.tint = 0x212f55;
        app.stage.addChild(kelp1);

        // My coral sprite
        let coral = PIXI.Sprite.from("img/coral.png");
        coral.x = 300;
        coral.scale.set(.5);
        coral.tint = 0x253152;
        app.stage.addChild(coral);

        // My school sprite
        let school = PIXI.Sprite.from("img/school.png");
        school.tint = 0x090c14;
        school.x = 200;
        school.y = 55;
        school.scale.set(.15);
        app.stage.addChild(school);

        // My second kelp sprite
        let kelp2 = PIXI.Sprite.from("img/kelp.png");
        kelp2.scale.set(.675);
        kelp2.y = .4;
        app.stage.addChild(kelp2);

        // My second coral sprite
        let coral2 = PIXI.Sprite.from("img/coral.png");
        coral2.scale.set(.8);
        coral2.y = 20;
        coral2.x = -400;
        coral2.tint = 0x5676c7;
        app.stage.addChild(coral2);

        // My third fish sprite
        let fish3 = PIXI.Sprite.from("img/betta.png");
        fish3.scale.set(.1);
        fish3.x = 350;
        fish3.y = 50;
        fish3.tint = 0x2e3f6b;
        app.stage.addChild(fish3);

        // My container for the first two fish sprites
        var my_container = new PIXI.Container();
        my_container.addChild(fish1);
        my_container.addChild(fish2);
        my_container.y = 100;
        app.stage.addChild(my_container);

        // My sprite for the bubbles
        let bubble1 = new PIXI.Sprite.from("img/bubble.png");
        bubble1.scale.set(.01);
        app.stage.addChild(bubble1);

        let bubble2 = new PIXI.Sprite.from("img/bubble.png");
        bubble2.scale.set(.01);
        bubble2.x = 80;
        app.stage.addChild(bubble2);

        let bubble3 = new PIXI.Sprite.from("img/bubble.png");
        bubble3.scale.set(.01);
        bubble3.x = 90;
        app.stage.addChild(bubble3);

        let bubble4 = new PIXI.Sprite.from("img/bubble.png");
        bubble4.scale.set(.01);
        bubble4.x = 105;
        app.stage.addChild(bubble4);

        let bubble5 = new PIXI.Sprite.from("img/bubble.png");
        bubble5.scale.set(.01);
        bubble5.x = 550;
        app.stage.addChild(bubble5);

        let bubble6 = new PIXI.Sprite.from("img/bubble.png");
        bubble6.scale.set(.01);
        bubble6.x = 570;
        app.stage.addChild(bubble6);

        let bubble7 = new PIXI.Sprite.from("img/bubble.png");
        bubble7.scale.set(.01);
        bubble7.x = 600;
        app.stage.addChild(bubble7);

        let bubble8 = new PIXI.Sprite.from("img/bubble.png");
        bubble8.scale.set(.01);
        bubble8.x = 610;
        app.stage.addChild(bubble8);

        // My player sprite
        let player = new PIXI.Sprite.from("img/minnow.png");
        player.scale.set(.05);
        player.x = 325;
        player.y = 175;
        app.stage.addChild(player);

        // turn background interactive
        background.interactive = true;
        // call moveTo function when screen is clicked
        background.on('mousedown', moveTo);

        // ANimation loop function
        function animationLoop() {
            let time = Date.now();

            let bubbly1 = Math.sin(time / 500) * 5;
            let bubbly2 = Math.cos(time / 500) * 5;
            //let sway = Math.sin(time / 1500) * 10;

            // Bubble animations
            bubble1.y = bubbly1;
            bubble2.y = bubbly2;
            bubble3.y = bubbly2;
            bubble4.y = bubbly1;

            bubble5.y = bubbly2;
            bubble6.y = bubbly1;
            bubble7.y = bubbly1;
            bubble8.y = bubbly2;

            //setTimeout(animationLoop, 1000 / 30);
            requestAnimationFrame(animationLoop);
        }
        animationLoop();

        let Animate = {};

        // animate function
        Animate.to = function (obj, end) {
            return new Promise((resolve, reject) => {

                // initial state for animated objects
                var start = {
                    x: obj.x,
                    y: obj.y
                }

                // set defaults for duration and easing
                if (end.duration == undefined) end.duration = 0;
                if (end.easing == undefined) end.easing = Animate.linear;

                // the start time of the animation
                var startTime = Date.now();

                // new animation loop
                function loop() {

                    // calculate the delta variable, time lapsed since start
                    let ticker = Date.now() - startTime;
                    let delta = ticker / end.duration;

                    // if animation done, end
                    if (delta >= 1) {
                        obj.x = end.x;
                        obj.y = end.y;
                        console.log("done");
                        resolve();
                        return;
                    }

                    // interpolation function
                    let lerp = (a, b, n) => {
                        return (1 - n) * a + n * b;
                    }
                    // interpolate x and y coordinates, start loop
                    obj.x = lerp(start.x, end.x, delta);
                    obj.y = lerp(start.y, end.y, delta);
                    obj.animationID = requestAnimationFrame(loop);
                }

                // clear animation ID to avoid competing loops
                cancelAnimationFrame(obj.animationID);
                // begin loop proper
                loop();
                // end promise
            });

        };

        // stop animation function
        Animate.stop = function (obj) {
            cancelAnimationFrame(obj.animationID);
        }

        //ease functions
        Animate.linear = x => x;

        Animate.easeIn = x => x * x;

        Animate.easeOut = x => 1 - (1 - x) * (1 - x);

        Animate.easeInOut = x => x < .5 ? 2 * x * x : 1 - Math.pow(-2 * x + 2, 2) / 2;

        // pause animation function
        function pause(ms) {
            return new Promise((resolve, reject) => {
                setTimeout(resolve, ms);
            });
        }

        // idle animations for sprites
        // animate fish1
        async function idleSwim1() {
            await Animate.to(fish1, {
                x: 420, y: 20,
                duration: 3000,
                easing: Animate.easeInOut
            });
            await Animate.to(fish1, {
                x: 420, y: 50,
                duration: 2000,
                easing: Animate.easeInOut
            });
            idleSwim1();
        }
        idleSwim1();

        // create fish food graphic
        let fishFood = new PIXI.Graphics();
        fishFood.beginFill(0x964B00);
        fishFood.drawCircle(450, 10, 2, 50); //450,25,2,50 with y -150
        app.stage.addChild(fishFood);
        fishFood.visible = false;

        // make fish1 interactive
        fish1.interactive = true;
        fish1.on('pointerdown', feeding);

        // fish1 interaction function, rotation change
        async function feeding() {
            fishFood.visible = true;
            fishFood.alpha = 1;
            fish1.pivot.x = 500;
            fish1.pivot.y = 1200;
            fish1.rotation = 1.5;
            async function feed() {
                await Animate.to(fish1, {
                    x: 420, y: -70,
                    duration: 2000,
                    easing: Animate.easeInOut
                });
                await pause(1000);
                feed();
                idleSwim1();
                fishFood.alpha = 0;
                fish1.rotation = 0;
            };
            feed();
        }

        // animate fish2, cycle random tint colors
        async function idleSwim2() {
            await Animate.to(fish2, {
                x: 30, y: 20,
                duration: 2000,
                easing: Animate.easeInOut
            });
            fish2.tint = (Math.floor(Math.random() * 0xFFFFFF));
            await Animate.to(fish2, {
                x: 30, y: 60,
                duration: 2000,
                easing: Animate.easeInOut
            });
            idleSwim2();
        }
        idleSwim2();

        // animate fish3
        async function idleSwim3() {
            await Animate.to(fish3, {
                x: 350, y: 0,
                duration: 3000,
                easing: Animate.easeInOut
            });
            await Animate.to(fish3, {
                x: 350, y: 20,
                duration: 3000,
                easing: Animate.easeInOut
            });
            idleSwim3();
        }
        idleSwim3();

        // animate background school of fish, get larger as pass right
        async function backgroundFish() {
            await Animate.to(school, {
                x: -1000, y: 55,
                duration: 3000,
            });
            await school.scale.set(-.25);
            await school.alpha == .95;
            await Animate.to(school, {
                x: 2000, y: 200,
                duration: 2100,
            });
            await school.scale.set(.10);
            backgroundFish();
        }
        backgroundFish();

        // animate kelp
        async function sway() {
            await Animate.to(kelp1, {
                x: 50, y: 0,
                duration: 5000,
                easing: Animate.easeInOut
            });
            await Animate.to(kelp1, {
                x: 20, y: 0,
                duration: 5000,
                easing: Animate.easeInOut
            });
            sway();
        }
        sway();
        async function sway2() {
            await Animate.to(kelp2, {
                x: 50, y: 0,
                duration: 4000,
                easing: Animate.easeInOut
            });
            await Animate.to(kelp2, {
                x: 30, y: 0,
                duration: 4000,
                easing: Animate.easeInOut
            });
            sway2();
        }
        sway2();

        // player animation idle state
        async function playerIdle() {
            await Animate.to(player, {
                x: 325,
                y: 150,
                duration: 3000,
                easing: Animate.easeInOut
            })
            await Animate.to(player, {
                x: 325,
                y: 200,
                duration: 3000,
                easing: Animate.easeInOut
            })
            playerIdle();
        }
        playerIdle();

        // player interaction on click anywhere with tail whip
        async function moveTo(e, data) {
            await Animate.to(player, {
                x: e.data.global.x,
                y: e.data.global.y,
                duration: 2000,
                easing: Animate.easeInOut
            });
            // try { } catch (error) { console.log(error) }
            // throw new Error('ignore');
            await pause(400);
            player.width = 20;
            await pause(100);
            player.width = 45.6;
            moveTo();
            playerIdle();
        }
        moveTo();

        // if (checkCollide(player, fish1)){
        //     console.log("touched");
        // }

        // console.log(player.getBounds());
        // console.log(fish1.getBounds());

        // if(player.getBounds() === fish1.getBounds()){
        //     console.log('collide');
        // }
        // else(console.log('not touching'))
        // // check collision function
        // function checkCollide(a, b) {
        //     let aBox = a.getBounds();
        //     let bBox = b.getBounds();

        //     return aBox.x + aBox.width > bBox.x && 
        //         aBox.x < bBox.x + bBox.width &&
        //         aBox.y + aBox.height > bBox.y &&
        //         aBox.y < bBox.y + bBox.height;
        // }
        // checkCollide();

        //OvO

    </script>
    <p>by Timothy Blajsa</p>
</body>

</html>